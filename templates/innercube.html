{% extends "base.html" %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/innercube.css') }}">
{% endblock %}

{% block content %}
<main class="page-innercube">
  <!-- HERO -->
  <section class="hero-innercube" style="background-image: url('{{ url_for('static', filename='images/innercube-sunset.jpg') }}');">
    <div class="hero-overlay"></div>

    <div class="hero-inner">
      <h1>The InnerCube Test</h1>
      <p class="lede">
        A symbolic journey through space, form, and feeling.<br>
        Discover your creative archetype and the story waiting to unfold.
      </p>

      <div class="cta-row">
        <a href="#take-test" class="btn primary" id="btn-take-test">Take the Test</a>
        <a href="#take-test" class="btn ghost">Learn More</a>
        <a href="#take-test" class="btn ghost">Ask a Question</a>
      </div>
    </div>
  </section>

  <!-- INFO SECTION -->
  <section class="innercube-info">
    <div class="container">
      <h2>About the InnerCube</h2>
      <p>
        The InnerCube Test reveals your creative alignment through a series of visual and symbolic reflections.
        Each response shows how you perceive and shape the world around you.
      </p>
      <ol class="steps">
        <li><strong>Step 1:</strong> Visualize a cube in open space.</li>
        <li><strong>Step 2:</strong> Notice size, color, texture, and distance.</li>
        <li><strong>Step 3:</strong> Add the ladder, horse, flowers, and weather.</li>
      </ol>

      <div class="cta-center">
        <a href="#take-test" class="btn primary" id="btn-begin">Begin (3 minutes)</a>
      </div>
    </div>
  </section>

  <!-- TEST EMBED -->
<section id="innercube-test-section" class="innercube-test-section" style="padding:60px 0;">
  <div class="container" style="max-width:1000px;margin:0 auto;text-align:center;">
    <h2>Start the InnerCube Test</h2>
    <p class="lede">Answer a few symbolic prompts. Takes about 3 minutes.</p>

   <!-- Tally embed -->
<iframe
  data-tally-src="https://tally.so/r/w2YBZ9?transparentBackground=1&hideTitle=1"
  width="100%"
  height="900"
  frameborder="0"
  marginheight="0"
  marginwidth="0"
  title="InnerCube Archetype Test">
</iframe>

<script>
  (function () {
    var d = document, src = "https://tally.so/widgets/embed.js";
    if (!d.querySelector('script[src="' + src + '"]')) {
      var s = d.createElement("script");
      s.src = src;
      s.onload = function () { Tally.loadEmbeds(); };
      d.body.appendChild(s);
    } else {
      Tally.loadEmbeds();
    }
  })();
</script>
<script>
  (function () {
    var d = document, src = "https://tally.so/widgets/embed.js";
    if (!d.querySelector('script[src="' + src + '"]')) {
      var s = d.createElement("script");
      s.src = src;
      s.onload = function () { Tally.loadEmbeds(); };
      d.body.appendChild(s);
    } else {
      Tally.loadEmbeds();
    }
  })();
</script>
  <script>
    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        const id = a.getAttribute('href').slice(1);
        const el = document.getElementById(id);
        if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth' }); }
      });
    });

    function loadTally() {
      if (window.tallyLoaded) return;
      window.tallyLoaded = true;
      const holder = document.getElementById('tally-embed');
      const src = holder.dataset.src;
      holder.innerHTML = `
        <div class="iframe-wrapper">
          <iframe data-tally-src="${src}" width="100%" height="720" frameborder="0" marginheight="0"
            marginwidth="0" title="InnerCube Test"></iframe>
        </div>`;
      const s = document.createElement('script');
      s.src = 'https://tally.so/widgets/embed.js';
      s.async = true;
      document.body.appendChild(s);
    }

    // Load on click
    document.getElementById('btn-take-test').addEventListener('click', loadTally);
    document.getElementById('btn-begin').addEventListener('click', loadTally);

    // Load when section is visible
    const target = document.getElementById('take-test');
    if ('IntersectionObserver' in window && target) {
      const obs = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) loadTally();
      }, { threshold: 0.1 });
      obs.observe(target);
    }
  </script>
  <!-- ABOUT MODAL -->
<div class="modal" id="modal-about" role="dialog" aria-modal="true" aria-labelledby="about-title" hidden>
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="document">
    <button class="modal__close" aria-label="Close" data-close>&times;</button>
    <h2 id="about-title">About the InnerCube</h2>
    <p class="muted">
      The InnerCube maps your imaginative choices (cube, ladder, horse, flowers, weather) to four core archetypes:
      <em>Dreamer, Observer, Alchemist, Visionary</em>. Your preview email explains your leading type and how to work with it.
    </p>
    <ul class="modal__list">
      <li>3-minute test • poetic, visual prompts</li>
      <li>Instant preview delivered to your inbox</li>
      <li>Upgrade to a 3-page personalized PDF (optional)</li>
    </ul>
    <div class="modal__cta">
      <a class="btn primary" href="#take-test" id="about-begin">Begin the Test</a>
    </div>
  </div>
</div>

<!-- CONTACT MODAL -->
<div class="modal" id="modal-contact" role="dialog" aria-modal="true" aria-labelledby="contact-title" hidden>
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="document">
    <button class="modal__close" aria-label="Close" data-close>&times;</button>
    <h2 id="contact-title">Ask a Question</h2>
    <p class="muted">We usually reply within 24 hours.</p>

    <!-- Simple mailto (you can replace with a form action later) -->
    <form class="modal__form" onsubmit="window.location.href=`mailto:hello@archetyperetreats.com?subject=InnerCube%20Question&body=${encodeURIComponent(document.getElementById('q-msg').value)}`; return false;">
      <label class="modal__label" for="q-msg">Your question</label>
      <textarea id="q-msg" class="modal__input" rows="5" placeholder="Type your message…"></textarea>
      <div class="modal__cta">
        <button type="submit" class="btn primary">Send Email</button>
        <a class="btn ghost" href="mailto:hello@archetyperetreats.com">Open email app</a>
      </div>
    </form>
  </div>
</div>
  <script>
  // --- Modal helpers ---
  function openModal(el) { el.hidden = false; document.body.classList.add('modal-open'); }
  function closeModal(el) { el.hidden = true; document.body.classList.remove('modal-open'); }

  const aboutModal   = document.getElementById('modal-about');
  const contactModal = document.getElementById('modal-contact');

  document.getElementById('open-about')?.addEventListener('click', () => openModal(aboutModal));
  document.getElementById('open-contact')?.addEventListener('click', () => openModal(contactModal));

  // Close on backdrop / X / Esc
  document.querySelectorAll('.modal [data-close]').forEach(btn => {
    btn.addEventListener('click', e => closeModal(e.target.closest('.modal')));
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') [aboutModal, contactModal].forEach(m => !m.hidden && closeModal(m));
  });

  // Keep existing smooth-scroll + lazy Tally loader working
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', e => {
      const id = a.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth' }); }
    });
  });
  function loadTally() {
    if (window.tallyLoaded) return;
    window.tallyLoaded = true;
    const holder = document.getElementById('tally-embed');
    const src = holder.dataset.src;
    holder.innerHTML = `<div class="iframe-wrapper"><iframe data-tally-src="${src}" width="100%" height="720" frameborder="0" title="InnerCube Test"></iframe></div>`;
    const s = document.createElement('script'); s.src = 'https://tally.so/widgets/embed.js'; s.async = true; document.body.appendChild(s);
  }
  document.getElementById('btn-take-test')?.addEventListener('click', loadTally);
  document.getElementById('btn-begin')?.addEventListener('click', loadTally);
  const target = document.getElementById('innercube-test-section');
  if ('IntersectionObserver' in window && target) {
    new IntersectionObserver(es => { if (es[0].isIntersecting) loadTally(); }, {threshold:0.1}).observe(target);
  }
  // CTA inside modal
  document.getElementById('about-begin')?.addEventListener('click', () => {
    closeModal(aboutModal); loadTally();
  });
<script>
  // Smooth-scroll to the test section when arriving with a hash
  window.addEventListener('load', () => {
    const id = location.hash && location.hash.slice(1);
    const el = id && document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  });
</script>

</main>
{% endblock %}
